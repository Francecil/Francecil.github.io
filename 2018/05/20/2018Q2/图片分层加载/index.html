<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.1.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://gahing.top').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="一、引言1.1 编写目的介绍图片分层加载系统架构及技术方案，结合懒加载后的总流程，梳理常见问题及相应解决方案。">
<meta property="og:type" content="article">
<meta property="og:title" content="前端图片分层加载详解">
<meta property="og:url" content="https:&#x2F;&#x2F;gahing.top&#x2F;2018&#x2F;05&#x2F;20&#x2F;2018Q2&#x2F;%E5%9B%BE%E7%89%87%E5%88%86%E5%B1%82%E5%8A%A0%E8%BD%BD&#x2F;index.html">
<meta property="og:site_name" content="gahing 的博客">
<meta property="og:description" content="一、引言1.1 编写目的介绍图片分层加载系统架构及技术方案，结合懒加载后的总流程，梳理常见问题及相应解决方案。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-05-19T17:00:00.000Z">
<meta property="article:modified_time" content="2020-04-01T15:21:31.154Z">
<meta property="article:author" content="gahing">
<meta property="article:tag" content="前端优化">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://gahing.top/2018/05/20/2018Q2/%E5%9B%BE%E7%89%87%E5%88%86%E5%B1%82%E5%8A%A0%E8%BD%BD/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>前端图片分层加载详解 | gahing 的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">gahing 的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">gahing.top</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="搜索..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://gahing.top/2018/05/20/2018Q2/%E5%9B%BE%E7%89%87%E5%88%86%E5%B1%82%E5%8A%A0%E8%BD%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/uploads/avatar.jpg">
      <meta itemprop="name" content="gahing">
      <meta itemprop="description" content="微信公众号：切图仔的前端之路">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="gahing 的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          前端图片分层加载详解
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-05-20 01:00:00" itemprop="dateCreated datePublished" datetime="2018-05-20T01:00:00+08:00">2018-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2020-04-01 23:21:31" itemprop="dateModified" datetime="2020-04-01T23:21:31+08:00">2020-04-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%A4%A7%E5%89%8D%E7%AB%AF/" itemprop="url" rel="index">
                    <span itemprop="name">大前端</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="一、引言"><a href="#一、引言" class="headerlink" title="一、引言"></a>一、引言</h1><h2 id="1-1-编写目的"><a href="#1-1-编写目的" class="headerlink" title="1.1 编写目的"></a>1.1 编写目的</h2><p>介绍图片分层加载系统架构及技术方案，结合懒加载后的总流程，梳理常见问题及相应解决方案。</p>
<a id="more"></a>

<h2 id="1-2-项目背景"><a href="#1-2-项目背景" class="headerlink" title="1.2 项目背景"></a>1.2 项目背景</h2><h3 id="1-2-1-背景"><a href="#1-2-1-背景" class="headerlink" title="1.2.1 背景"></a>1.2.1 背景</h3><p>前端优化站的功能模块之一，属于图像优化范畴。</p>
<h3 id="1-2-2-业界客户现状"><a href="#1-2-2-业界客户现状" class="headerlink" title="1.2.2 业界客户现状"></a>1.2.2 业界客户现状</h3><p>大部分客户在图片加载上没做优化，页面直接加载原图，浏览器会发起大量原图请求，导致页面加载时间过长，网络带宽消耗大。</p>
<p>因此，我们提出了一整套的图片优化解决方案，实现页面图片懒加载，加快客户页面加载速度，节省流量。</p>
<h3 id="1-2-3-友商技术方案"><a href="#1-2-3-友商技术方案" class="headerlink" title="1.2.3 友商技术方案"></a>1.2.3 友商技术方案</h3><p>Akamai 在图像优化上提出了三个解决方案：</p>
<ul>
<li>自适应压缩<blockquote>
<p>基于网络条件分层加载,提供多种压缩级别的图像资源</p>
</blockquote>
</li>
<li>懒加载<blockquote>
<p>仅加载当前浏览器视区可见的图像，当用户向下滑动时加载新图像</p>
</blockquote>
</li>
<li>特定图像格式优化<blockquote>
<p>webp、jpeg2000等图像格式可以降低负载，而不影响图片质量,但只有特定浏览器兼容</p>
</blockquote>
</li>
</ul>
<p><strong>目前本方案能实现以上功能</strong>，并在懒加载方案继续优化，结合了预加载的思想，当pageload后且scroll一定时间没有触发，会触发图像加载机制，用于满足某些客户需求。</p>
<h2 id="1-3-术语定义"><a href="#1-3-术语定义" class="headerlink" title="1.3 术语定义"></a>1.3 术语定义</h2><p>小图： 分辨率不变，图像质量较低的图片资源-模糊图<br>小小图： 后台又对小图做了压缩处理</p>
<h2 id="1-4-参考资料"><a href="#1-4-参考资料" class="headerlink" title="1.4 参考资料"></a>1.4 参考资料</h2><p><a href="https://www.akamai.com/cn/zh/web-and-mobile-performance.jsp" target="_blank" rel="noopener">AKAMAI WEB 性能解决方案</a></p>
<p><a href="https://github.com/tuupola/jquery_lazyload/tree/master" target="_blank" rel="noopener">lazy_load开源库</a></p>
<h1 id="二、系统架构"><a href="#二、系统架构" class="headerlink" title="二、系统架构"></a>二、系统架构</h1><p><em>本套系统分为前端和后台，本文侧重于介绍前端部分。</em></p>
<p>当浏览器发起html文档请求时，后台会对该文档进行修改并返回。</p>
<p>先介绍下后台的<strong>html文档改写规则</strong>(仅针对图像优化功能):</p>
<blockquote>
<p>在文档底部插入图片优化的js代码，配置项通过设置script节点的自定义属性来实现。</p>
<p>主要配置项：散列域名，是否开启懒加载，懒加载策略，是否处理<code>background-image</code></p>
</blockquote>
<p>前端这边收到html文档之后，与后台交互流程如下：</p>
<h2 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">  st(浏览器dom解析)--&gt;op[浏览器发起图片请求]</span><br><span class="line">  op--&gt;op2[后台处理并返回模糊图]</span><br><span class="line">  op2--&gt;co&#123; pageload完成? &#125;</span><br><span class="line">  co--no--&gt;co</span><br><span class="line">  co--yes--&gt;op3[扫描文档的图像资源]</span><br><span class="line">  op3--&gt;op4[修改图像url地址的域名部分并作为图像新的src]</span><br><span class="line">  op4--&gt;op5[浏览器发起新的图片请求]</span><br><span class="line">  op5--&gt;co2&#123; 后台判断是否有缓存? &#125;</span><br><span class="line">  co2--no--&gt;op6[回源获取并缓存]</span><br><span class="line">  co2--yes--&gt;op7[进行响应]</span><br><span class="line">  op6--&gt;op7</span><br></pre></td></tr></table></figure>

<h2 id="时序图"><a href="#时序图" class="headerlink" title="时序图"></a>时序图</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sequenceDiagram</span><br><span class="line">participant 浏览器</span><br><span class="line">participant shark</span><br><span class="line">participant 源站</span><br><span class="line">浏览器 -&gt;&gt; shark:请求图像资源</span><br><span class="line">Note right of shark:没有缓存，请求源站</span><br><span class="line">shark -&gt;&gt; 源站:请求图像资源</span><br><span class="line">Note right of shark:缓存图像</span><br><span class="line">shark -&gt;&gt; shark:图像模糊化</span><br><span class="line">shark --&gt;&gt; 浏览器:返回模糊图</span><br><span class="line">Note right of 浏览器:dom解析完毕&lt;br&#x2F;&gt;扫描文档</span><br><span class="line">浏览器 -&gt;&gt; shark:请求图片质量标识wsq对应图像</span><br><span class="line">shark -&gt;&gt; shark:根据wsq对原图做相应的压缩</span><br><span class="line">shark --&gt;&gt;浏览器:返回wsq对应图片</span><br></pre></td></tr></table></figure>

<p><del>或者采用另外一个方案，修改html文档中img的src，原图放在data-src中，这样可以控制哪些图片需要做分层，可解决后面提到的 <strong><code>根据媒体属性的渲染</code></strong> 问题，但是改写文档的工作量和难度都比较大</del></p>
<h2 id="前端流程"><a href="#前端流程" class="headerlink" title="前端流程"></a>前端流程</h2><p>原图请求通过url替换的方式，不采用ajax</p>
<h3 id="总流程"><a href="#总流程" class="headerlink" title="总流程"></a>总流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">  st(开始)--&gt;init((初始化))</span><br><span class="line">  init--&gt;obs[添加DOMContentLoaded,Load事件监听器]</span><br><span class="line">  obs--&gt;DOMContentLoaded[DOMContentLoaded事件触发]</span><br><span class="line">  DOMContentLoaded--&gt;cal[利用html文档下载速度来进行简单测速]</span><br><span class="line">  cal--&gt;firstScreenPicSpeed[参照网速压缩比对照表得到首屏图片压缩比]</span><br><span class="line">  firstScreenPicSpeed--&gt;firstScreen((扫描文档,获取图片节点))</span><br><span class="line">  firstScreen--&gt;quicksort[按视距快排图片节点]</span><br><span class="line">  quicksort--&gt;judgeCache[任取一模糊图的name,通过transferSize是否为0来判断本次加载是否为无缓存加载]</span><br><span class="line">  judgeCache--&gt;firstScreenCal[获取视距处于首屏的图片节点]</span><br><span class="line">  firstScreenCal--&gt;oripicload((进行原图加载))</span><br><span class="line">  oripicload--&gt;load[Load事件触发]</span><br><span class="line">  load--&gt;speedtest[采用测速算法测速,得到相应图像压缩比]</span><br><span class="line">  speedtest--&gt;islazyLoad&#123;是否懒加载&#125;</span><br><span class="line">  islazyLoad--是--&gt;lazyload[启动懒加载策略]</span><br><span class="line">  islazyLoad--否--&gt;replaceOther[找到其他未进行原图加载的节点]</span><br><span class="line">  replaceOther--&gt;oripicload1((进行原图加载))</span><br><span class="line">  lazyload--&gt;islazycompleted&#123;懒加载完毕?&#125;</span><br><span class="line">  islazycompleted--是--&gt;ed(结束)</span><br><span class="line">  islazycompleted--否--&gt;scall&#123;是否进行窗口滚动&#125;</span><br><span class="line">  scall--是--&gt;debounceCul[节流处理,获取满足视距条件的未进行原图加载的节点]</span><br><span class="line">  debounceCul--&gt;oripicload2((进行原图加载))</span><br><span class="line">  oripicload2--&gt;islazycompleted</span><br><span class="line">  scall--否--&gt;mousetimeout&#123;鼠标事件10s未触发&#125;</span><br><span class="line">  mousetimeout--是--&gt;replaceOther</span><br><span class="line">  mousetimeout--否--&gt;scall</span><br><span class="line">  oripicload1--&gt;ed</span><br></pre></td></tr></table></figure>
<h3 id="初始化具体流程"><a href="#初始化具体流程" class="headerlink" title="初始化具体流程"></a>初始化具体流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">  init(初始化开始)--&gt;evalElement(解析script标签中自定义属性)</span><br><span class="line">  evalElement--&gt;getHost[获取可替换图片域名]</span><br><span class="line">  evalElement--&gt;getHashHost[获取散列域名]</span><br><span class="line">  evalElement--&gt;getLazy[获取懒加载策略]</span><br><span class="line">  evalElement--&gt;getSpeedZip[获取网速压缩比参照表]</span><br><span class="line">  evalElement--&gt;getTTL[获取图片缓存时间]</span><br><span class="line">  getHost--&gt;initStop(初始化结束)</span><br><span class="line">  getHashHost--&gt;initStop</span><br><span class="line">  getLazy--&gt;initStop</span><br><span class="line">  getSpeedZip--&gt;initStop</span><br><span class="line">  getTTL--&gt;initStop</span><br></pre></td></tr></table></figure>

<h3 id="原图加载具体流程"><a href="#原图加载具体流程" class="headerlink" title="原图加载具体流程"></a>原图加载具体流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">graph TB</span><br><span class="line">oripicstart(原图加载开始)--&gt;judgeEle&#123;判断节点类型&#125;</span><br><span class="line">judgeEle--picture节点--&gt;getpic[获取其子节点中source节点和img节点中src和srcset属性中的图片url]</span><br><span class="line">judgeEle--img节点--&gt;getsrcset[获取节点的src和srcset属性中的图片url]</span><br><span class="line">judgeEle--video节点--&gt;getposter[获取节点的poster属性中的图片url]</span><br><span class="line">judgeEle--其他节点--&gt;getother[获取节点background-image的图片url]</span><br><span class="line">getpic--&gt;getfinalurl((url替换))</span><br><span class="line"></span><br><span class="line">getsrcset--&gt;getfinalurl1((url替换))</span><br><span class="line">getposter--&gt;getfinalurl1((url替换))</span><br><span class="line">getother--&gt;getfinalurl1((url替换))</span><br><span class="line"></span><br><span class="line">getfinalurl1--&gt;newImg[new Image的方式加载资源,其url为替换后的url,可能需要设置srcset属性]</span><br><span class="line">newImg--&gt;onload[Image的onload触发]</span><br><span class="line">onload--&gt;updateEle</span><br><span class="line"></span><br><span class="line">getfinalurl-.-hashurl[将模糊图url地址通过一定算法映射到固定的散列域名,得到新的图片url-newUrl]</span><br><span class="line">hashurl--&gt;findstorage&#123;localstorage中是否有newUrl且压缩比一样或更低的记录&#125;</span><br><span class="line">findstorage--是--&gt;isExpired&#123;是否过期&#125;</span><br><span class="line">findstorage--否--&gt;carrycur</span><br><span class="line">isExpired--否--&gt;carryhigh[取未过期的压缩比最低的记录,newUrl后带上压缩比参数]</span><br><span class="line">isExpired--是--&gt;carrycur[图片url后带上当前的压缩比]</span><br><span class="line">carryhigh--&gt;replaceEnd(url替换完毕)</span><br><span class="line">carrycur--&gt;replaceEnd</span><br><span class="line">getfinalurl--&gt;updateEle[将节点属性的图片url进行替换]</span><br><span class="line">updateEle--&gt;updatelocal[更新localstorage]</span><br><span class="line">updatelocal--&gt;isnocache&#123;无缓存加载或localstorage中没有命中缓存?&#125;</span><br><span class="line">isnocache--否--&gt;oripicstop[原图加载完毕]</span><br><span class="line">isnocache--是--&gt;update[更新 url-压缩比-ttl 记录]</span><br><span class="line">update--&gt;oripicstop</span><br></pre></td></tr></table></figure>
<h3 id="扫描文档，获取图片节点具体流程"><a href="#扫描文档，获取图片节点具体流程" class="headerlink" title="扫描文档，获取图片节点具体流程"></a>扫描文档，获取图片节点具体流程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">init(初始化节点列表)--&gt;scanOver&#123;文档扫描完毕?&#125;</span><br><span class="line">scanOver--否--&gt;scan[扫描文档]</span><br><span class="line">scan--&gt;getPicEle[获取picture节点]</span><br><span class="line">getPicEle--&gt;getchild[获取子节点的src和srcset中所有图片的url]</span><br><span class="line">getchild--&gt;ishost&#123;节点图片url的域名存在可替换图片域名?&#125;</span><br><span class="line">ishost--否--&gt;skip[跳过该节点]</span><br><span class="line">ishost--是--&gt;addList[节点列表加入该节点]</span><br><span class="line">scan--&gt;getImgEle[获取父节点非picture的img节点]</span><br><span class="line">getImgEle--&gt;getsrc[获取节点的src或srcset属性]</span><br><span class="line">getsrc--&gt;ishost</span><br><span class="line">scan--&gt;getstyleEle[获取style中含有background-image属性且值为图片url的节点]</span><br><span class="line">getstyleEle--&gt;ishost</span><br><span class="line">scan--&gt;getcss[扫描css文档,获取含有background-image属性且值为图片url的css规则]</span><br><span class="line">getcss--&gt;getcssDom[匹配css规则得到相应节点]</span><br><span class="line">getcssDom--&gt;ishost</span><br><span class="line">scan--&gt;getvideo[获取含poster属性且值为图片url的video节点]</span><br><span class="line">getvideo--&gt;ishost</span><br><span class="line">skip--&gt;scanOver</span><br><span class="line">addList--&gt;scanOver</span><br><span class="line">scanOver--是--&gt;scanEnd(节点获取完毕)</span><br></pre></td></tr></table></figure>

<h1 id="三、常见问题及解决方案"><a href="#三、常见问题及解决方案" class="headerlink" title="三、常见问题及解决方案"></a>三、常见问题及解决方案</h1><h2 id="3-1-源站有做懒加载策略的"><a href="#3-1-源站有做懒加载策略的" class="headerlink" title="3.1 源站有做懒加载策略的"></a>3.1 源站有做懒加载策略的</h2><p>默认情况下，会出现后续请求原图时，后台返回小图的问题。</p>
<p>因为访问的域名没有做更改，后台默认小图处理。</p>
<p>此外，还会发起更多的请求</p>
<ul>
<li>img中没有src</li>
</ul>
<p>pageload后扫描文档并拿不到src 故不会发起获取原图的异步请求</p>
<ul>
<li>img中src为源站的小图</li>
</ul>
<p>初次访问小图，后台会返回一张小小图，pageload之后我们扫描文档会去拿小图，加上懒加载策略触发又请求的图片，我们会发三次请求</p>
<p><strong><code>这个由客户配置，客户自己有做懒加载可以不选择我们的分层加载功能，所以这边我们无需考虑</code></strong></p>
<h2 id="3-2-css和style中background-image是否进行处理"><a href="#3-2-css和style中background-image是否进行处理" class="headerlink" title="3.2 css和style中background-image是否进行处理"></a>3.2 css和style中background-image是否进行处理</h2><p><strong><code>目前前端这边可以做到扫描文档获取到图片地址,对于伪类css（如 div:hover{background:xxx}）还得做额外处理</code></strong></p>
<p>需要测试下伪类</p>
<p>对于 <code>background-image:inherit</code>（使用父节点的bg-image）不做处理</p>
<h2 id="3-3-根据媒体属性的渲染"><a href="#3-3-根据媒体属性的渲染" class="headerlink" title="3.3 根据媒体属性的渲染"></a>3.3 根据媒体属性的渲染</h2><ul>
<li><p><code>&lt;img&gt;</code>的srcset属性和css的image-set()</p>
</li>
<li><p><code>&lt;picture&gt;</code> source、img子节点</p>
</li>
</ul>
<p><del>初次返回小图，pageload之后前端这边不知道应该请求哪张图片，不知道有没有办法获取渲染的是哪张图</del><br>可以通过img节点的currentSrc拿到值。(注：picture的也是去拿img的currentSrc)</p>
<p>但还是有新的问题，这个是响应式的，界面变化又会去拿新的图片地址了</p>
<blockquote>
<p>故需要做img节点currentSrc值变化监听</p>
<p>目前没有找到直接监听currentSrc的方法，但是一般currentSrc的变化都是由窗口大小变化引起的，故需要节流监听下window.resize,判断currentSrc有变化没。</p>
</blockquote>
<p>后面发现，即使知道图片地址变化了，也并不能通过img改src的方式替换图片，因为srcset存在的时候src是无效的。</p>
<p><strong><code>故解法只有在pageload的时候，把srcset中图片的地址做替换</code></strong></p>
<h2 id="3-4-和懒加载结合的策略"><a href="#3-4-和懒加载结合的策略" class="headerlink" title="3.4 和懒加载结合的策略"></a>3.4 和懒加载结合的策略</h2><ul>
<li><p>加载全部小图，pageload后加载全部大图，不做懒加载</p>
</li>
<li><p>加载全部小图，滑动懒加载大图</p>
</li>
<li><p>加载首屏小图，滑动懒加载大图</p>
</li>
</ul>
<blockquote>
<p>目前是加载全部小图和首屏大图</p>
</blockquote>
<ul>
<li>loaded时开启懒加载，滑动懒加载大图，load前滑动不做处理</li>
<li>domcontentloaded时开启懒加载，未load前都是加载的原图。</li>
</ul>
<h2 id="3-5-原始图片较小，第二次不做加载"><a href="#3-5-原始图片较小，第二次不做加载" class="headerlink" title="3.5 原始图片较小，第二次不做加载"></a>3.5 原始图片较小，第二次不做加载</h2><p>采用ajax请求，根据响应值长度判断，响应值长度小于某个值 说明是错误请求或者不做加载</p>
<p>最后通过 window.URL.createObjectURL() 插入图片。但是该方案不能解决<code>问题3</code></p>
<p><strong>新方案</strong>：<strong><code>第一次发过来若是原图，设置缓存策略，后续请求，返回307重定向到原来地址，这时候本地有缓存就不会再发请求了</code></strong></p>
<h2 id="3-6-根据网络速度，在第二次按照一定比例加载高清图"><a href="#3-6-根据网络速度，在第二次按照一定比例加载高清图" class="headerlink" title="3.6 根据网络速度，在第二次按照一定比例加载高清图"></a>3.6 根据网络速度，在第二次按照一定比例加载高清图</h2><p>如何测速？</p>
<p>利用<code>Resource Timing API</code> ，现代浏览器大部分支持，详见caniuse，</p>
<p>若不支持(safari11以下)，则采用<code>navigation timing</code></p>
<p>该api必须在<code>page load</code>后才能使用。</p>
<p><strong><code>具体网络带宽估计算法需要一定策略来评判</code></strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算浏览器加载该文档的时间</span></span><br><span class="line"><span class="keyword">var</span> nav = performance.getEntriesByType(<span class="string">'navigation'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">console</span>.log(nav.responseEnd-nav.responseStart,nav.transferSize,nav.transferSize/(nav.responseEnd-nav.responseStart)+<span class="string">"KB/s"</span>)</span><br></pre></td></tr></table></figure>

<p>facebook的测速算法：</p>
<p>前面资源还有做一定的过滤和排序（按responseEnd），</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">performance.getEntriesByType(<span class="string">'resource'</span>).filter(<span class="function"><span class="params">v</span>=&gt;</span>v.responseEnd-v.responseStart&gt;<span class="number">30</span>).reduce(<span class="function">(<span class="params">sum,cur</span>)=&gt;</span><span class="number">0.5</span>*(cur.transferSize / (cur.responseEnd - cur.responseStart || <span class="number">1</span>))+<span class="number">0.5</span>*sum,<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>facebook带宽利用率：<code>所有响应时间和及响应间隔和/所有响应时间</code></p>
<p><del>我们假设网络速度恒定（不抖动），给出以下数据（响应开始时间，响应结束时间，资源大小）。我们会计算每一段的响应速度，最后取最大值。这样解决了之前只计算html文档存在的问题，并且该方案的结果也兼容了html文档计算。<br>这边假设了网络不抖动。当出现网络抖动情况，会出现前面下载速度和后面不一致情况，但是由于我们后面也会做计算，在数据量足够的情况下是趋于稳定的。<br>推荐数据结构：线段树+扫描线 <code>O(nlogn)</code><br>暴力解法：<code>O(n²)</code></del></p>
<h3 id="算法流程"><a href="#算法流程" class="headerlink" title="算法流程"></a>算法流程</h3><ol start="0">
<li><p>数据结构体</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  name: v.name,<span class="comment">//标识而已</span></span><br><span class="line">  start: v.responseStart,</span><br><span class="line">  end: v.responseEnd,</span><br><span class="line">  size: v.transferSize,</span><br><span class="line">  <span class="comment">//KB/S 新算法中不用该参数</span></span><br><span class="line">  speed: v.transferSize / (v.responseEnd - v.responseStart || <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>过滤、按start值升序排序</p>
<blockquote>
<p>剔除小数据,保留满足以下条件数据–》小数据会导致出现过大的网速计算结果，剔除小数据后对总体结果影响小，<br><code>v.transferSize &gt; 100 &amp;&amp; (v.responseEnd - v.responseStart) &gt; 10 &amp;&amp; v.responseStart &lt; loadTime</code></p>
</blockquote>
</li>
<li><p>分组，将响应时间无连续的分组</p>
</li>
<li><p>计算每组的每条响应的速度（具体计算见如下），并计算整组均值、方差、最大值</p>
<ul>
<li>3.1 将每条响应的start,end放入numArr</li>
<li>3.2 numArr去重，升序排序</li>
<li>3.3 将每条响应的时间区间按numArr值分割，当其他响应有重复的区间，该条响应的该时间区间会乘以重复的数量(包括自己)</li>
<li>3.4 将每段时间区间相加，形成该响应的实际响应时间，用size处于该时间则为该响应的实际速度</li>
<li>3.5 计算每条响应的速度</li>
</ul>
</li>
<li><p>根据size做加权平均，得到每组带宽估算值。</p>
</li>
<li><p>比较每组数据的结果，取最大值</p>
</li>
</ol>
<p>目前仍存在问题：小数据短时间，当×上一定并发时，会使数据过大。</p>
<blockquote>
<p>size加权平均，弱化小数据的影响</p>
</blockquote>
<p>算法效率过低O(n³)：需要改进</p>
<blockquote>
<p>目前O(n²)，仍可以剪枝优化</p>
</blockquote>
<h2 id="3-7-图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图"><a href="#3-7-图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图" class="headerlink" title="3.7 图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图"></a>3.7 图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图</h2><p>较难，目前不研究</p>
<h2 id="3-8-存在缓存，还是会分层加载，体验不好"><a href="#3-8-存在缓存，还是会分层加载，体验不好" class="headerlink" title="3.8 存在缓存，还是会分层加载，体验不好"></a>3.8 存在缓存，还是会分层加载，体验不好</h2><p>简单的将过程放在domcontentloaded时并不能解决问题，会导致初次加载或者无缓存加载，可能不触发分层机制（模糊的src未下完又直接被替换了）。</p>
<p><strong>分层加载逻辑修改为</strong>：</p>
<ol>
<li>html的原始文档,img仅做占位<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 初次加载的文档 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">figure</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> <span class="attr">data-rawheight</span>=<span class="string">"667"</span> <span class="attr">data-rawwidth</span>=<span class="string">"1000"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">width</span>=<span class="string">"1000"</span> <span class="attr">data-original</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_r.jpg"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"data:image/svg+xml;utf8,<span class="symbol">&amp;lt;</span>svg%20xmlns='http://www.w3.org/2000/svg'%20width='1000'%20height='667'<span class="symbol">&amp;gt;</span><span class="symbol">&amp;lt;</span>    /svg<span class="symbol">&amp;gt;</span>"</span><span class="attr">data-rawheight</span>=<span class="string">"667"</span> <span class="attr">data-rawwidth</span>=<span class="string">"1000"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb lazy"</span> <span class="attr">width</span>=<span class="string">"1000"</span>           <span class="attr">data-original</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_r.jpg"</span></span></span><br><span class="line"><span class="tag">      <span class="attr">data-actualsrc</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>domcontentload后，js将img用div替换，并开始模糊和高清图片的加载<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">figure</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> <span class="attr">data-rawheight</span>=<span class="string">"667"</span> <span class="attr">data-rawwidth</span>=<span class="string">"1000"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">width</span>=<span class="string">"1000"</span> <span class="attr">data-original</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_r.jpg"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--VagurImage中设置了背景色--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"VagurImage"</span> <span class="attr">data-src</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> <span class="attr">style</span>=<span class="string">"width:654px;height:980.51px"</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--设置了高斯模糊和透明度--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"VagueImage-mask is-active"</span>&gt;</span></span><br><span class="line">        ::before</span><br><span class="line">        ::after</span><br><span class="line">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>模糊图片下载完毕,设置background-image<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 文档其他地方不变不变--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"VagueImage-mask is-active"</span> <span class="attr">background-image</span>=<span class="string">"url('https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_60w.jpg')"</span>&gt;</span></span><br><span class="line">  ::before</span><br><span class="line">  ::after</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>高清图下载完毕<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">figure</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">noscript</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> <span class="attr">data-rawheight</span>=<span class="string">"667"</span> <span class="attr">data-rawwidth</span>=<span class="string">"1000"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">width</span>=<span class="string">"1000"</span> <span class="attr">data-original</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_r.jpg"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">noscript</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> <span class="attr">data-rawheight</span>=<span class="string">"667"</span> <span class="attr">data-rawwidth</span>=<span class="string">"1000"</span> <span class="attr">class</span>=<span class="string">"origin_image zh-lightbox-thumb lazy"</span> <span class="attr">width</span>=<span class="string">"1000"</span>           <span class="attr">data-original</span>=<span class="string">"https://pic4.zhimg.com/1355440786fffad694ed56130dbbc0bc_r.jpg"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">data-actualsrc</span>=<span class="string">"https://pic4.zhimg.com/50/1355440786fffad694ed56130dbbc0bc_hd.jpg"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">figure</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>js代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//还是放在domcontentloaded执行</span></span><br><span class="line"><span class="built_in">document</span>.addEventListener(<span class="string">"DOMContentLoaded"</span>,func,<span class="literal">false</span>)</span><br><span class="line"><span class="comment">//func</span></span><br><span class="line"><span class="comment">//采用两次Image，若img直接加载模糊图的话，只需imgLarge即可</span></span><br><span class="line"><span class="keyword">let</span> smallImage = <span class="built_in">document</span>.getElementById(<span class="string">'small-img'</span>)</span><br><span class="line"><span class="keyword">let</span> img = <span class="keyword">new</span> Image()</span><br><span class="line">img.src=smallImage.src</span><br><span class="line"><span class="comment">//由于smallImage的已经load了，这边我们利用缓存再加载同个图，会去拿缓存触发onload</span></span><br><span class="line">img.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="comment">//下图加载完毕</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> imgLarge = <span class="keyword">new</span> Image();</span><br><span class="line">imgLarge.src = smallImage.getAttribute(<span class="string">"originSrc"</span>)</span><br><span class="line">imgLarge.onload = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  smallImage.src = imgLarge.src</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>但是目前该做法有个问题，就是原图获取是在domcontentloaded的时候进行，此时还未进行测速，或者说此时进行测速用我们的测速算法是不准的（资源下载过程中<code>performance.getEntries</code>是拿不到该资源的）。<br>一个想法是对于未测速时，都加载原图</p>
</blockquote>
<h2 id="3-9-带网络参数，不会命中原图已有本地缓存"><a href="#3-9-带网络参数，不会命中原图已有本地缓存" class="headerlink" title="3.9 带网络参数，不会命中原图已有本地缓存"></a>3.9 带网络参数，不会命中原图已有本地缓存</h2><p>问题详细描述：本地已缓存原图<code>a.jpg</code>，本地通过网络计算需要去请求低清图片<code>a.jpg?q=50</code>,这样就浪费了原来的原图缓存了。</p>
<p>解法：不同比例图片load后，将<code>url-TTL</code>放到localstorage中。每次网络计算完后，先查询缓存中有没有更高清的且未过期的图片，有的话选更高清的进行请求，不对localstorage做处理 ；否则请求相应网络状态的图片，onload后保存或更新localstorage。</p>
<blockquote>
<p>注1：每种清晰度图片的TTL可配置，通过script节点自定义属性设置。</p>
</blockquote>
<blockquote>
<p>注2：本地只有低清缓存不考虑请求是因为我们当前网络状态算还行了，不需要用低清的，否则多次清晰度切换会对用户造成视觉上影响。</p>
</blockquote>
<p>当前这个问题也可以通过<code>blur+动画</code>解决，需要产品评估下。</p>
<p>存在问题：强刷页面或者<code>disable cache</code>，请求图片得到响应后，<code>cache-control</code>本地缓存时间会重新计算。相应的我们localstorage的TTL也要进行修改</p>
<p>解决方案：这边我们主要就是判断图片是否为无缓存请求，当为无缓存请求，img.onload后需要对localstorage进行更新。<br>至于怎么判断是否为无缓存，就用<code>performance.getEntriesByName(&#39;当前加载图片的url&#39;)</code>结果是否满足某些规则来判断</p>
<h2 id="3-10-原图访问会做url替换，当前不是用h2-而是用域分片，当两次图片请求不是同个域时会不走缓存"><a href="#3-10-原图访问会做url替换，当前不是用h2-而是用域分片，当两次图片请求不是同个域时会不走缓存" class="headerlink" title="3.10 原图访问会做url替换，当前不是用h2 而是用域分片，当两次图片请求不是同个域时会不走缓存"></a>3.10 原图访问会做url替换，当前不是用h2 而是用域分片，当两次图片请求不是同个域时会不走缓存</h2><blockquote>
<p>方法1： 将图片链接与域名做map映射<code>url-&gt;host</code>，保存在localstorage，下次访问会先查一遍，没有的话就随机访问并保存在localstorage</p>
</blockquote>
<blockquote>
<p>方法2： 利用算法将图片url映射到某个MOD值(length为散列域名列表大小) 需要保证每个计算结果值不变且映射每个域名的概率一致<br>js 名称的每个字符的ascii码值相加再mod length</p>
</blockquote>
<h2 id="3-11-JavaScript被禁用-分层加载拿不到原图"><a href="#3-11-JavaScript被禁用-分层加载拿不到原图" class="headerlink" title="3.11 JavaScript被禁用 分层加载拿不到原图"></a>3.11 JavaScript被禁用 分层加载拿不到原图</h2><p>目前不考虑</p>
<h2 id="3-12-透明遮罩，动画让图片切换变得自然"><a href="#3-12-透明遮罩，动画让图片切换变得自然" class="headerlink" title="3.12 透明遮罩，动画让图片切换变得自然"></a>3.12 透明遮罩，动画让图片切换变得自然</h2><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.VagueImage-mask</span> &#123;</span><br><span class="line">    <span class="attribute">z-index</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">background-size</span>: cover;</span><br><span class="line">    <span class="attribute">background-position</span>: <span class="number">50%</span>;</span><br><span class="line">    <span class="attribute">background-repeat</span>: no-repeat;</span><br><span class="line">    <span class="attribute">transition</span>: opacity .<span class="number">3s</span> ease-in</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过 由于我们不是提供的小分辨率图再放大，而是提供同分辨率的模糊图，这边就不进行透明遮罩处理了。</p>
<h2 id="3-13-图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片"><a href="#3-13-图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片" class="headerlink" title="3.13 图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片"></a>3.13 图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片</h2><ol>
<li>定时扫描<br>无任何优化时，jd 3k多节点  每次扫描耗时20ms左右，后面可能可以做增量优化。<br>但有个问题就是需要一直去做定时扫描，对客户网页性能有影响</li>
</ol>
<p>技术难度低</p>
<ol start="2">
<li>元素监听</li>
</ol>
<h3 id="通过Object-defineProperty去监听src的set"><a href="#通过Object-defineProperty去监听src的set" class="headerlink" title="通过Object.defineProperty去监听src的set"></a>通过<code>Object.defineProperty</code>去监听src的set</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.defineProperty(HTMLImageElement.prototype, <span class="string">'src'</span>, &#123;</span><br><span class="line">      enumerable: <span class="literal">false</span>,</span><br><span class="line">      configurable: <span class="literal">true</span>,</span><br><span class="line">      <span class="keyword">get</span>: function () &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getAttribute(<span class="string">'src'</span>)</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="keyword">set</span>: function (newval) &#123;</span><br><span class="line">        <span class="comment">//属于可替换域的</span></span><br><span class="line">        <span class="keyword">if</span> (newval.indexOf(<span class="string">"data:image"</span>) === <span class="number">-1</span> &amp;&amp; Util.inlist(newval, settings.imgHostList)) &#123;</span><br><span class="line">          <span class="keyword">this</span>.setAttribute(<span class="string">'src'</span>, Util.getNewUrlFromCache(newval, MAX_QUALITY).url);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.setAttribute(<span class="string">'src'</span>, newval);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//TODO srcset的defineProperty</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">'Image Element set error'</span>, error)</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>兼容IE8，IE8支持对html元素对象进行 defineProperty ,enumerable 需要设置为false</p>
<h3 id="document-write方法重载"><a href="#document-write方法重载" class="headerlink" title="document.write方法重载"></a>document.write方法重载</h3><p>注：要么必须支持js异步加载让document.write延后执行，要么把图片优化脚本放在head中</p>
<p>以下步骤仅测试图片优化功能用，暂不兼容js异步加载功能，document.write方法也是等图片优化脚本加载完毕后执行</p>
<ol>
<li>获得当前执行脚本节点-currentScript<blockquote>
<p>作为标志位，内容将插入在该节点之前，此处命中为节点 CUR</p>
</blockquote>
</li>
<li>找到CUR的父节点CURP,创建一个CURP.tagName的节点CURC，其innerHTML为所插入内容</li>
<li>遍历节点，找到满足条件的图片节点并进行host替换</li>
<li>将CURC的所有子节点insertBefore(CUR)</li>
</ol>
<p>该做法获取不到css渲染</p>
<p>技术难度较高</p>
<h2 id="3-14-图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像"><a href="#3-14-图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像" class="headerlink" title="3.14 图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像"></a>3.14 图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像</h2><p>有空写</p>
<h1 id="四、详细设计"><a href="#四、详细设计" class="headerlink" title="四、详细设计"></a>四、详细设计</h1><h2 id="4-1-获取script自定义数据"><a href="#4-1-获取script自定义数据" class="headerlink" title="4.1 获取script自定义数据"></a>4.1 获取script自定义数据</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">data-host</span>=<span class="string">"xxx"</span> <span class="attr">id</span>=<span class="string">"speed"</span>&gt;</span></span><br><span class="line"><span class="javascript">  <span class="keyword">let</span> ele = <span class="built_in">document</span>.currentScript</span></span><br><span class="line"><span class="javascript">  <span class="built_in">console</span>.log(ele.attributes[<span class="string">"data-host"</span>].nodeValue)</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这样可以获取到本script节点的自定义数据</p>
<h2 id="4-2-注册window-load事件监听器"><a href="#4-2-注册window-load事件监听器" class="headerlink" title="4.2 注册window.load事件监听器"></a>4.2 注册window.load事件监听器</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addLoadEvent</span>(<span class="params">func</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.addEventListener) &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, func, <span class="literal">false</span>)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//低版ie兼容</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.attachEvent) &#123;</span><br><span class="line">      <span class="built_in">window</span>.attachEvent(<span class="string">"onload"</span>, func)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">addLoadEvent(streamFunc);</span><br></pre></td></tr></table></figure>
<h2 id="4-3-计算用户网络状况"><a href="#4-3-计算用户网络状况" class="headerlink" title="4.3 计算用户网络状况"></a>4.3 计算用户网络状况</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//计算浏览器加载该文档的时间</span></span><br><span class="line"><span class="keyword">var</span> nav = performance.getEntriesByType(<span class="string">'navigation'</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="built_in">console</span>.log(nav.responseEnd-nav.responseStart,nav.transferSize,nav.transferSize/(nav.responseEnd-nav.responseStart)+<span class="string">"KB/s"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="4-4-节点获取"><a href="#4-4-节点获取" class="headerlink" title="4.4 节点获取"></a>4.4 节点获取</h2><h3 id="4-4-1-获取img元素"><a href="#4-4-1-获取img元素" class="headerlink" title="4.4.1 获取img元素"></a>4.4.1 获取img元素</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imgDOMList = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"img"</span>);</span><br><span class="line">[...imgDOMList].forEach(<span class="function">(<span class="params">dom</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//其他处理</span></span><br><span class="line">    <span class="comment">//含srcset属性做额外标识</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-获取style中的background"><a href="#4-4-2-获取style中的background" class="headerlink" title="4.4.2 获取style中的background"></a>4.4.2 获取style中的background</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> styleDOMList = <span class="built_in">document</span>.querySelectorAll(<span class="string">"[style*=background]"</span>);</span><br><span class="line">[...styleDOMList].filter(<span class="function"><span class="params">v</span>=&gt;</span>v.nodeType == <span class="number">1</span> &amp;&amp; v.style.backgroundImage).forEach(<span class="function">(<span class="params">dom</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">//其他处理</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="4-4-3-获取css中的background"><a href="#4-4-3-获取css中的background" class="headerlink" title="4.4.3 获取css中的background"></a>4.4.3 获取css中的background</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取css中的background，</span></span><br><span class="line"><span class="built_in">document</span>.styleSheets.filter(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">//根据v.href过滤第三方css</span></span><br><span class="line">  <span class="keyword">return</span> </span><br><span class="line">&#125;).forEach(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> rules = v.cssRules || v.rules</span><br><span class="line">  rules.forEach(<span class="function"><span class="params">v</span>=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> sel = v.selectorText</span><br><span class="line">    <span class="keyword">let</span> domList = <span class="built_in">document</span>.querySelectorAll(sel);</span><br><span class="line">    <span class="keyword">if</span>(v.style.backgroundImage)&#123;</span><br><span class="line">      <span class="comment">//满足条件的操作</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>完整版本</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">queryImgNodeList: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> list = []</span><br><span class="line">        <span class="comment">//获取picture节点</span></span><br><span class="line">        ; (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> pictureList = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"picture"</span>);</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pictureList.length; i++) &#123;</span><br><span class="line">            <span class="comment">//仅img子节点存在时进行下一步判断，一般都会有img子节点</span></span><br><span class="line">            <span class="keyword">if</span> (pictureList[i].getElementsByTagName(<span class="string">"img"</span>).length) &#123;</span><br><span class="line">              <span class="keyword">var</span> urlList = []</span><br><span class="line">              <span class="keyword">var</span> nodeList = pictureList[i].querySelectorAll(<span class="string">"source,img"</span>)</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; nodeList.length; j++) &#123;</span><br><span class="line">                <span class="keyword">var</span> srcset = nodeList[j].getAttribute(<span class="string">"srcset"</span>)</span><br><span class="line">                <span class="keyword">var</span> src = nodeList[j].getAttribute(<span class="string">"src"</span>)</span><br><span class="line">                <span class="keyword">if</span> (srcset) &#123;</span><br><span class="line">                  urlList = urlList.concat(getUrlListInSrcset(srcset))</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (src &amp;&amp; src.indexOf(<span class="string">"data:image"</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">                  urlList.push(src)</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (urlList.length &gt; <span class="number">0</span> &amp;&amp; inlist(urlList, settings.imgHostList)) &#123;</span><br><span class="line">                list.push(<span class="keyword">new</span> WsNode(<span class="string">'picture'</span>, pictureList[i]))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)()</span><br><span class="line">        <span class="comment">// 获取video节点</span></span><br><span class="line">        ; (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> videoList = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"video"</span>);</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; videoList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> poster = videoList[i].getAttribute(<span class="string">"poster"</span>)</span><br><span class="line">            <span class="keyword">if</span> (poster &amp;&amp; poster.indexOf(<span class="string">"data:image"</span>) === <span class="number">-1</span> &amp;&amp; inlist(poster, settings.imgHostList)) &#123;</span><br><span class="line">              list.push(<span class="keyword">new</span> WsNode(<span class="string">'video'</span>, videoList[i]))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)()</span><br><span class="line">        <span class="comment">// 获取img节点</span></span><br><span class="line">        ; (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> imgList = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"img"</span>);</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; imgList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (imgList[i].parentNode.nodeName !== <span class="string">"PICTURE"</span>) &#123;</span><br><span class="line">              <span class="keyword">var</span> urlList = []</span><br><span class="line">              <span class="keyword">var</span> srcset = imgList[i].getAttribute(<span class="string">"srcset"</span>)</span><br><span class="line">              <span class="keyword">var</span> src = imgList[i].getAttribute(<span class="string">"src"</span>)</span><br><span class="line">              <span class="keyword">if</span> (srcset) &#123;</span><br><span class="line">                urlList = getUrlListInSrcset(srcset)</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (src &amp;&amp; src.indexOf(<span class="string">"data:image"</span>) === <span class="number">-1</span>) &#123;</span><br><span class="line">                urlList.push(src)</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (urlList.length &gt; <span class="number">0</span> &amp;&amp; inlist(urlList, settings.imgHostList)) &#123;</span><br><span class="line">                list.push(<span class="keyword">new</span> WsNode(<span class="string">'img'</span>, imgList[i]))</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)()</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        //获取style*background-image</span></span><br><span class="line"><span class="comment">        ; (function () &#123;</span></span><br><span class="line"><span class="comment">          var styleList = document.querySelectorAll("[style]");</span></span><br><span class="line"><span class="comment">          //ie8 not support [style*=background]</span></span><br><span class="line"><span class="comment">          for (var i = 0; i &lt; styleList.length; i++) &#123;</span></span><br><span class="line"><span class="comment">            var cur = styleList[i];</span></span><br><span class="line"><span class="comment">            if (cur.nodeType == 1 &amp;&amp; cur.style.backgroundImage) &#123;</span></span><br><span class="line"><span class="comment">              var url = getBackgroundImageUrl(cur.style.backgroundImage);</span></span><br><span class="line"><span class="comment">              if (url &amp;&amp; inlist(url, settings.imgHostList)) &#123;</span></span><br><span class="line"><span class="comment">                list.push(new WsNode('style', cur))</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">        &#125;)()</span></span><br><span class="line"><span class="comment">        //获取css background-image</span></span><br><span class="line"><span class="comment">        ; (function () &#123;</span></span><br><span class="line"><span class="comment">          for (var i = 0; i &lt; document.styleSheets.length; i++) &#123;</span></span><br><span class="line"><span class="comment">            var href = document.styleSheets[i].href;</span></span><br><span class="line"><span class="comment">            //过滤不满足规则的css外链</span></span><br><span class="line"><span class="comment">            if (href &amp;&amp; !inlist(href, settings.cssHostList)) &#123;</span></span><br><span class="line"><span class="comment">              continue</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">            var rules = document.styleSheets[i].cssRules || document.styleSheets[i].rules</span></span><br><span class="line"><span class="comment">            //遍历每条规则</span></span><br><span class="line"><span class="comment">            for (var j = 0; j &lt; rules.length; j++) &#123;</span></span><br><span class="line"><span class="comment">              var url = getBackgroundImageUrl(rules[j].style.backgroundImage)</span></span><br><span class="line"><span class="comment">              if (url &amp;&amp; inlist(url, settings.imgHostList)) &#123;</span></span><br><span class="line"><span class="comment">                var eles = document.querySelectorAll(rules[j].selectorText)</span></span><br><span class="line"><span class="comment">                for (var k = 0; k &lt; eles.length; k++) &#123;</span></span><br><span class="line"><span class="comment">                  list.push(new WsNode('css', eles[k], url))</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment">              &#125;</span></span><br><span class="line"><span class="comment">            &#125;</span></span><br><span class="line"><span class="comment">          &#125;</span></span><br><span class="line"><span class="comment">        &#125;)()*/</span></span><br><span class="line">        <span class="comment">//获取background-image的节点</span></span><br><span class="line">        ; (<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">var</span> bglist = <span class="built_in">document</span>.querySelectorAll(<span class="string">"*"</span>)</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bglist.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bglist[i].nodeType === <span class="number">1</span>) &#123;</span><br><span class="line">              <span class="keyword">var</span> url = getBackgroundImageUrl(getStyleBackgroundImage(bglist[i]))</span><br><span class="line">              <span class="keyword">if</span> (url &amp;&amp; inlist(url, settings.imgHostList)) &#123;</span><br><span class="line">                list.push(<span class="keyword">new</span> WsNode(<span class="string">'bg'</span>, bglist[i], url))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)()</span><br><span class="line">      <span class="keyword">return</span> list</span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="4-4-4-获取picture节点"><a href="#4-4-4-获取picture节点" class="headerlink" title="4.4.4 获取picture节点"></a>4.4.4 获取picture节点</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> imgDOMList = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"picture"</span>);</span><br><span class="line">imgDOMList.forEach(<span class="function"><span class="params">v</span>=&gt;</span>v.childList.forEach(<span class="function"><span class="params">c</span>=&gt;</span>c))</span><br></pre></td></tr></table></figure>

<p>为避免重复计算，先扫描<code>picture</code>,再扫描<code>img</code></p>
<h2 id="4-5-懒加载"><a href="#4-5-懒加载" class="headerlink" title="4.5 懒加载"></a>4.5 懒加载</h2><h3 id="方法1-IntersectionObserver"><a href="#方法1-IntersectionObserver" class="headerlink" title="方法1 IntersectionObserver"></a>方法1 IntersectionObserver</h3><p>兼容性差，开发量低</p>
<h3 id="方法2-scroll-window-requestAnimationFrame"><a href="#方法2-scroll-window-requestAnimationFrame" class="headerlink" title="方法2 scroll+window.requestAnimationFrame()"></a>方法2 scroll+window.requestAnimationFrame()</h3><p>兼容性高，开发量还行</p>
<h2 id="4-6-图片地址替换"><a href="#4-6-图片地址替换" class="headerlink" title="4.6 图片地址替换"></a>4.6 图片地址替换</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断是否为可替换域名</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">judgeHost</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 相对路径转绝对路径(IE6, IE7)无效</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">directlink</span>(<span class="params">url</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> a = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>);</span><br><span class="line">  a.href = url;</span><br><span class="line">  <span class="keyword">return</span> a.href;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 根据散列域名、网速替换url</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">originUrl,hashHost,networkSpeed</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
    </div>

    
    
    
        <div class="reward-container">
  <div>您的支持将鼓励我继续创作！</div>
  <button disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/uploads/wechatpay.png" alt="gahing 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/uploads/alipay.png" alt="gahing 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%89%8D%E7%AB%AF%E4%BC%98%E5%8C%96/" rel="tag"># 前端优化</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/05/14/2018Q2/%E5%9F%BA%E4%BA%8ECDN%E7%9A%84%E5%89%8D%E7%AB%AF%E4%BC%98%E5%8C%96%E5%8F%AF%E8%A1%8C%E6%80%A7%E5%88%86%E6%9E%90/" rel="prev" title="基于CDN的前端优化可行性分析">
      <i class="fa fa-chevron-left"></i> 基于CDN的前端优化可行性分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2018/06/14/2018Q2/git%E5%91%BD%E4%BB%A4%E5%AD%A6%E4%B9%A0/" rel="next" title="git命令学习">
      git命令学习 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一、引言"><span class="nav-number">1.</span> <span class="nav-text">一、引言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-编写目的"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 编写目的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-项目背景"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 项目背景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-背景"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 背景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-业界客户现状"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 业界客户现状</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-友商技术方案"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 友商技术方案</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-术语定义"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 术语定义</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-参考资料"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 参考资料</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、系统架构"><span class="nav-number">2.</span> <span class="nav-text">二、系统架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#流程图"><span class="nav-number">2.1.</span> <span class="nav-text">流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时序图"><span class="nav-number">2.2.</span> <span class="nav-text">时序图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#前端流程"><span class="nav-number">2.3.</span> <span class="nav-text">前端流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#总流程"><span class="nav-number">2.3.1.</span> <span class="nav-text">总流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#初始化具体流程"><span class="nav-number">2.3.2.</span> <span class="nav-text">初始化具体流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#原图加载具体流程"><span class="nav-number">2.3.3.</span> <span class="nav-text">原图加载具体流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扫描文档，获取图片节点具体流程"><span class="nav-number">2.3.4.</span> <span class="nav-text">扫描文档，获取图片节点具体流程</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、常见问题及解决方案"><span class="nav-number">3.</span> <span class="nav-text">三、常见问题及解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-源站有做懒加载策略的"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 源站有做懒加载策略的</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-css和style中background-image是否进行处理"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 css和style中background-image是否进行处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-根据媒体属性的渲染"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 根据媒体属性的渲染</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-和懒加载结合的策略"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 和懒加载结合的策略</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-原始图片较小，第二次不做加载"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 原始图片较小，第二次不做加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-根据网络速度，在第二次按照一定比例加载高清图"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 根据网络速度，在第二次按照一定比例加载高清图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#算法流程"><span class="nav-number">3.6.1.</span> <span class="nav-text">算法流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 图片合并，第一次是模糊图片，第二次是补充信息，合并后变成原图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-8-存在缓存，还是会分层加载，体验不好"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 存在缓存，还是会分层加载，体验不好</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-9-带网络参数，不会命中原图已有本地缓存"><span class="nav-number">3.9.</span> <span class="nav-text">3.9 带网络参数，不会命中原图已有本地缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-10-原图访问会做url替换，当前不是用h2-而是用域分片，当两次图片请求不是同个域时会不走缓存"><span class="nav-number">3.10.</span> <span class="nav-text">3.10 原图访问会做url替换，当前不是用h2 而是用域分片，当两次图片请求不是同个域时会不走缓存</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-11-JavaScript被禁用-分层加载拿不到原图"><span class="nav-number">3.11.</span> <span class="nav-text">3.11 JavaScript被禁用 分层加载拿不到原图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-12-透明遮罩，动画让图片切换变得自然"><span class="nav-number">3.12.</span> <span class="nav-text">3.12 透明遮罩，动画让图片切换变得自然</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-13-图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片"><span class="nav-number">3.13.</span> <span class="nav-text">3.13 图片节点扫描完毕后，后续通过js动态增加的Image节点，若图片src满足分层规则，后台会返回模糊图片</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通过Object-defineProperty去监听src的set"><span class="nav-number">3.13.1.</span> <span class="nav-text">通过Object.defineProperty去监听src的set</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#document-write方法重载"><span class="nav-number">3.13.2.</span> <span class="nav-text">document.write方法重载</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-14-图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像"><span class="nav-number">3.14.</span> <span class="nav-text">3.14 图片节点寻找完毕后，需要进行一个视距排序，这样当没开启懒加载时才会优先加载首屏图像</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、详细设计"><span class="nav-number">4.</span> <span class="nav-text">四、详细设计</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#4-1-获取script自定义数据"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 获取script自定义数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-2-注册window-load事件监听器"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 注册window.load事件监听器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-3-计算用户网络状况"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 计算用户网络状况</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-4-节点获取"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 节点获取</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-1-获取img元素"><span class="nav-number">4.4.1.</span> <span class="nav-text">4.4.1 获取img元素</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-2-获取style中的background"><span class="nav-number">4.4.2.</span> <span class="nav-text">4.4.2 获取style中的background</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-3-获取css中的background"><span class="nav-number">4.4.3.</span> <span class="nav-text">4.4.3 获取css中的background</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-4-获取picture节点"><span class="nav-number">4.4.4.</span> <span class="nav-text">4.4.4 获取picture节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-5-懒加载"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 懒加载</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方法1-IntersectionObserver"><span class="nav-number">4.5.1.</span> <span class="nav-text">方法1 IntersectionObserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法2-scroll-window-requestAnimationFrame"><span class="nav-number">4.5.2.</span> <span class="nav-text">方法2 scroll+window.requestAnimationFrame()</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-6-图片地址替换"><span class="nav-number">4.6.</span> <span class="nav-text">4.6 图片地址替换</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="gahing"
      src="/uploads/avatar.jpg">
  <p class="site-author-name" itemprop="name">gahing</p>
  <div class="site-description" itemprop="description">微信公众号：切图仔的前端之路</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">76</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">44</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/francecil" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;francecil" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:france.zjx@gmail.com" title="E-Mail → mailto:france.zjx@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      其他平台
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://juejin.im/user/59818c62f265da3e3a0bdbf0" title="https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;59818c62f265da3e3a0bdbf0" rel="noopener" target="_blank">掘金</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.hongweipeng.com/index.php/author/8/" title="https:&#x2F;&#x2F;www.hongweipeng.com&#x2F;index.php&#x2F;author&#x2F;8&#x2F;" rel="noopener" target="_blank">西二在线</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.cnblogs.com/france/" title="https:&#x2F;&#x2F;www.cnblogs.com&#x2F;france&#x2F;" rel="noopener" target="_blank">博客园</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://blog.csdn.net/u011644423/" title="https:&#x2F;&#x2F;blog.csdn.net&#x2F;u011644423&#x2F;" rel="noopener" target="_blank">CSDN</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        
  <div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">闽ICP备19024221号-1 </a>
      <img src="http://www.beian.gov.cn/img/ghs.png" style="display: inline-block;">
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">gahing</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v4.1.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
